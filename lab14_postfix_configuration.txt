RHCE RH254 HANDS-ON LAB: POSTFIX MAIL SERVER CONFIGURATION
==========================================================

LAB OBJECTIVE:
Install and configure Postfix mail server for sending and receiving emails with basic security settings

PREREQUISITES:
- RHEL 7/8 system with root access
- Network connectivity
- Understanding of email protocols (SMTP, POP3, IMAP)

LAB SCENARIO:
Configure Postfix as the primary mail server for domain example.com with local delivery and basic security features.

EQUIPMENT NEEDED:
- RHEL system (mail.example.com: 192.168.1.10)
- DNS server or /etc/hosts configuration
- Mail client for testing

LAB TASKS:

PART A: INSTALL AND BASIC CONFIGURATION
----------------------------------------

1. Install Postfix and related packages:
   # yum install postfix mailx -y
   # systemctl enable postfix

2. Stop and disable sendmail (if running):
   # systemctl stop sendmail
   # systemctl disable sendmail

3. Backup original configuration:
   # cp /etc/postfix/main.cf /etc/postfix/main.cf.backup

4. Configure basic Postfix settings:
   # Install Vim
   # yum install vim -y

   # vim /etc/postfix/main.cf
   
# Basic server information
myhostname = mail.example.com
mydomain = example.com
myorigin = $mydomain
   
# Network settings
inet_interfaces = all
inet_protocols = ipv4
   
# Mail delivery
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
mynetworks = 20.192.224.119, 127.0.0.0/8           (use Your Ip )
   
# Mailbox settings
home_mailbox = Maildir/
mailbox_command = 
   
# Message size limits
message_size_limit = 10240000
mailbox_size_limit = 1073741824

PART B: CONFIGURE MAIL DIRECTORIES AND USERS
---------------------------------------------

1. Create mail users:
   # useradd -m user1
   # useradd -m user2
   # useradd -m admin
   # passwd user1
   # passwd user2
   # passwd admin

2. Create Maildir structure:
   # mkdir -p /home/user1/Maildir/{new,cur,tmp}
   # mkdir -p /home/user2/Maildir/{new,cur,tmp}
   # mkdir -p /home/admin/Maildir/{new,cur,tmp}
   # chown -R user1:user1 /home/user1/Maildir
   # chown -R user2:user2 /home/user2/Maildir
   # chown -R admin:admin /home/admin/Maildir
   # chmod -R 700 /home/*/Maildir

3. Configure mail spool directory:
   # mkdir -p /var/spool/mail
   # chmod 1777 /var/spool/mail

PART C: CONFIGURE POSTFIX MAIN SETTINGS
----------------------------------------

1. Configure advanced Postfix settings:
   # vim /etc/postfix/main.cf
   
# Queue settings
maximal_queue_lifetime = 5d
bounce_queue_lifetime = 5d
minimal_backoff_time = 300s
maximal_backoff_time = 4000s
   
# Connection settings
smtpd_timeout = 300s
smtp_connect_timeout = 30s
   
# Logging
mail_spool_directory = /var/spool/mail
   
# Disable unnecessary features
disable_vrfy_command = yes
smtpd_helo_required = yes

2. Configure Postfix master process:
   # vim /etc/postfix/master.cf
   
   # SMTP daemon
   smtp      inet  n       -       n       -       -       smtpd
   
   # Submission port (587) for authenticated users
   submission inet n       -       n       -       -       smtpd
     -o syslog_name=postfix/submission
     -o smtpd_tls_security_level=encrypt
     -o smtpd_sasl_auth_enable=yes
     -o smtpd_reject_unlisted_recipient=no
     -o smtpd_client_restrictions=permit_sasl_authenticated,reject
     -o milter_macro_daemon_name=ORIGINATING

3. Test Postfix configuration:
   # postfix check
   # postconf -n

PART D: CONFIGURE FIREWALL AND SELINUX
---------------------------------------

1. Configure firewall for mail services:
   # Install Firewall
   # yum install firewalld -y
   # systemctl start firewalld
   # systemctl enable firewalld
   
   # firewall-cmd --permanent --add-service=http
   # firewall-cmd --permanent --add-service=https
   # firewall-cmd --reload 

   # firewall-cmd --permanent --add-service=smtp
   # firewall-cmd --permanent --add-port=587/tcp
   # firewall-cmd --reload

2. Configure SELinux for Postfix:
   # setsebool -P allow_postfix_local_write_mail_spool on
   # semanage fcontext -a -t mail_spool_t "/home/*/Maildir(/.*)?"
   # restorecon -R /home/*/Maildir

3. Check SELinux contexts:
   # ls -Z /var/spool/mail
   # ls -Z /home/user1/Maildir

PART E: START AND TEST POSTFIX
-------------------------------

1. Start Postfix service:
   # systemctl start postfix
   # systemctl status postfix

2. Verify Postfix is listening:
   # netstat -tulpn | grep :25
   # ss -tulpn | grep :25

3. Test local mail delivery:
   # echo "Test message" | mail -s "Test Subject" user1@example.com
   # echo "Another test" | mail -s "Test 2" user2@localhost

4. Check mail delivery:
   # ls -la /home/user1/Maildir/new/
   # cat /home/user1/Maildir/new/*

5. Test mail queue:
   # mailq
   # postqueue -p

PART F: CONFIGURE MAIL ALIASES
-------------------------------

1. Configure system aliases:
   # vim /etc/aliases
   
# System aliases
postmaster: admin
root: admin
webmaster: admin
abuse: admin
   
# User aliases
support: user1,user2
sales: user1
info: admin

2. Update aliases database:
   # newaliases
   # postalias /etc/aliases

3. Test aliases:
   # echo "Test to postmaster" | mail -s "Postmaster Test" postmaster
   # echo "Test to support" | mail -s "Support Test" support

PART G: CONFIGURE VIRTUAL DOMAINS
----------------------------------

1. Configure virtual domain mapping:
   # vim /etc/postfix/virtual
   
# Virtual domain mappings
info@example.com        admin
sales@example.com       user1
support@example.com     user1,user2
@otherdomain.com        admin

2. Update Postfix configuration for virtual domains:
   # vim /etc/postfix/main.cf
   
   # Add virtual domain support
   virtual_alias_domains = otherdomain.com
   virtual_alias_maps = hash:/etc/postfix/virtual

3. Update virtual database:
   # postmap /etc/postfix/virtual
   # postfix reload

PART H: CONFIGURE BASIC SECURITY
---------------------------------

1. Configure SMTP restrictions:
   # vim /etc/postfix/main.cf
   
# Client restrictions
smtpd_client_restrictions = 
   permit_mynetworks,
   permit_sasl_authenticated,
   reject_rbl_client zen.spamhaus.org,
   permit
   
# Helo restrictions
smtpd_helo_restrictions = 
   permit_mynetworks,
   permit_sasl_authenticated,
   reject_invalid_helo_hostname,
   reject_non_fqdn_helo_hostname,
   permit
   
# Sender restrictions
smtpd_sender_restrictions = 
   permit_mynetworks,
   permit_sasl_authenticated,
   reject_non_fqdn_sender,
   reject_unknown_sender_domain,
   permit
   
# Recipient restrictions
smtpd_recipient_restrictions = 
   permit_mynetworks,
   permit_sasl_authenticated,
   reject_non_fqdn_recipient,
   reject_unknown_recipient_domain,
   reject_unauth_destination,
   permit

2. Configure rate limiting:
   # vim /etc/postfix/main.cf
   
# Rate limiting
anvil_rate_time_unit = 60s
smtpd_client_connection_count_limit = 50
smtpd_client_connection_rate_limit = 30
smtpd_client_message_rate_limit = 100

PART I: TESTING AND MONITORING
-------------------------------

1. Test mail server functionality:
   # telnet localhost 25
   HELO example.com
   MAIL FROM: test@example.com
   RCPT TO: user1@example.com
   DATA
   Subject: Test message
   
   This is a test message.
   .
   QUIT

2. Monitor mail logs:
   # tail -f /var/log/maillog
   # grep postfix /var/log/messages

3. Check mail queue status:
   # postqueue -p
   # postsuper -d ALL deferred

4. Test with mail client:
   # mail user1
   Subject: Test from command line
   This is a test message from the command line.
   .

PART J: PERFORMANCE MONITORING
-------------------------------

1. Monitor Postfix processes:
   # ps aux | grep postfix
   # postfix status

2. Check mail statistics:
   # pflogsumm /var/log/maillog
   # postconf | grep queue

3. Monitor disk usage:
   # du -sh /var/spool/postfix/*
   # df -h /var/spool

TROUBLESHOOTING COMMANDS:
-------------------------
# postfix check
# postconf -n
# tail -f /var/log/maillog
# mailq
# postqueue -f
# systemctl status postfix

EXPECTED RESULTS:
-----------------
- Postfix service running and accepting connections
- Local mail delivery working
- Mail aliases functional
- Virtual domains configured
- Basic security restrictions active
- Mail logging operational

VALIDATION CHECKLIST:
---------------------
□ Postfix service running              Done
□ SMTP port (25) listening             Done
□ Local mail delivery working          Done
□ Aliases resolving correctly          Done
□ Virtual domains functional           Done
□ Security restrictions active         Done
□ Firewall allows SMTP traffic         Done

CLEANUP:
--------
# systemctl stop postfix
# systemctl disable postfix
# userdel -r user1 user2 admin
# firewall-cmd --permanent --remove-service=smtp
# firewall-cmd --reload
