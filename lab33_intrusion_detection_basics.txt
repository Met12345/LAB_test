RHCE RH254 HANDS-ON LAB: INTRUSION DETECTION BASICS
====================================================

LAB OBJECTIVE:
Implement basic intrusion detection and prevention systems using AIDE, fail2ban, and custom monitoring scripts

PREREQUISITES:
- RHEL 7/8 system with root access
- Understanding of security concepts
- Network services running for testing

LAB SCENARIO:
Configure intrusion detection systems to monitor file integrity, detect brute force attacks, and implement automated response mechanisms.

EQUIPMENT NEEDED:
- RHEL system (server1: 192.168.1.10)
- Client systems for attack simulation
- Various network services for monitoring

LAB TASKS:

PART A: INSTALL AND CONFIGURE AIDE (FILE INTEGRITY MONITORING)
---------------------------------------------------------------

1. Install AIDE (Advanced Intrusion Detection Environment):
   # yum install aide -y

2. Configure AIDE rules:
   # vim /etc/aide.conf
   
   # AIDE configuration file
   
   # Database and report locations
   database=file:/var/lib/aide/aide.db.gz
   database_out=file:/var/lib/aide/aide.db.new.gz
   gzip_dbout=yes
   
   # Report settings
   verbose=5
   report_url=file:/var/log/aide/aide.log
   report_url=stdout
   
   # Define what to check
   # R = p+i+n+u+g+s+m+c+md5
   # L = p+i+n+u+g
   # E = Empty group
   # > = Growing logfile p+u+g+i+n+S
   
   # System binaries
   /bin    R
   /sbin   R
   /usr/bin    R
   /usr/sbin   R
   /usr/local/bin  R
   
   # Libraries
   /lib    R
   /lib64  R
   /usr/lib    R
   /usr/lib64  R
   
   # Configuration files
   /etc    R
   
   # Critical system files
   /boot   R
   /root   R
   
   # Exclude frequently changing files
   !/var/log/.*
   !/var/spool/.*
   !/var/cache/.*
   !/tmp/.*
   !/proc/.*
   !/sys/.*
   !/dev/.*
   !/run/.*
   
   # Log files (growing)
   /var/log    >
   
   # Home directories (basic monitoring)
   /home   L

3. Create AIDE log directory:
   # mkdir -p /var/log/aide
   # chmod 700 /var/log/aide

4. Initialize AIDE database:
   # aide --init
   # mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz

PART B: CONFIGURE AIDE MONITORING AND REPORTING
------------------------------------------------

1. Create AIDE check script:
   # vim /usr/local/bin/aide-check.sh
   
   #!/bin/bash
   # AIDE integrity check script
   
   AIDE_LOG="/var/log/aide/aide-check-$(date +%Y%m%d_%H%M%S).log"
   ALERT_EMAIL="security@example.com"
   
   echo "Starting AIDE integrity check at $(date)" | tee $AIDE_LOG
   
   # Run AIDE check
   aide --check 2>&1 | tee -a $AIDE_LOG
   
   # Check exit status
   AIDE_STATUS=$?
   
   case $AIDE_STATUS in
       0)
           echo "AIDE check completed: No changes detected" | tee -a $AIDE_LOG
           ;;
       1)
           echo "AIDE check completed: Changes detected!" | tee -a $AIDE_LOG
           # Send alert email
           {
               echo "File integrity violations detected on $(hostname)"
               echo "Check time: $(date)"
               echo "Log file: $AIDE_LOG"
               echo
               echo "Summary of changes:"
               tail -50 $AIDE_LOG
           } | mail -s "AIDE Alert: File Integrity Violation" $ALERT_EMAIL
           ;;
       *)
           echo "AIDE check failed with status $AIDE_STATUS" | tee -a $AIDE_LOG
           echo "AIDE check failed on $(hostname)" | \
           mail -s "AIDE Error" $ALERT_EMAIL
           ;;
   esac
   
   echo "AIDE check completed at $(date)" | tee -a $AIDE_LOG
   
   # chmod +x /usr/local/bin/aide-check.sh

2. Create AIDE database update script:
   # vim /usr/local/bin/aide-update.sh
   
   #!/bin/bash
   # AIDE database update script
   
   echo "Updating AIDE database at $(date)"
   
   # Create new database
   aide --init
   
   if [ $? -eq 0 ]; then
       # Backup old database
       if [ -f /var/lib/aide/aide.db.gz ]; then
           cp /var/lib/aide/aide.db.gz /var/lib/aide/aide.db.backup.$(date +%Y%m%d)
       fi
       
       # Install new database
       mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
       
       echo "AIDE database updated successfully"
       echo "AIDE database updated on $(hostname) at $(date)" | \
       mail -s "AIDE Database Updated" security@example.com
   else
       echo "AIDE database update failed"
       echo "AIDE database update failed on $(hostname)" | \
       mail -s "AIDE Update Error" security@example.com
   fi
   
   # chmod +x /usr/local/bin/aide-update.sh

PART C: INSTALL AND CONFIGURE FAIL2BAN
---------------------------------------

1. Install fail2ban:
   # yum install epel-release -y
   # yum install fail2ban -y
   # systemctl enable fail2ban

2. Configure fail2ban main settings:
   # vim /etc/fail2ban/jail.local
   
   [DEFAULT]
   # Ban time (seconds)
   bantime = 3600
   
   # Find time window (seconds)
   findtime = 600
   
   # Number of failures before ban
   maxretry = 3
   
   # Backend for log monitoring
   backend = auto
   
   # Email settings
   destemail = security@example.com
   sendername = Fail2Ban
   mta = sendmail
   
   # Action to take
   action = %(action_mwl)s
   
   # Ignore local networks
   ignoreip = 127.0.0.1/8 192.168.1.0/24

3. Configure SSH protection:
   # vim /etc/fail2ban/jail.local
   
   [sshd]
   enabled = true
   port = ssh
   filter = sshd
   logpath = /var/log/secure
   maxretry = 3
   bantime = 3600
   findtime = 600

4. Configure additional service protection:
   # vim /etc/fail2ban/jail.local
   
   [httpd-auth]
   enabled = true
   port = http,https
   filter = apache-auth
   logpath = /var/log/httpd/error_log
   maxretry = 5
   
   [httpd-badbots]
   enabled = true
   port = http,https
   filter = apache-badbots
   logpath = /var/log/httpd/access_log
   maxretry = 2
   
   [postfix]
   enabled = true
   port = smtp,465,submission
   filter = postfix
   logpath = /var/log/maillog
   maxretry = 3

PART D: CREATE CUSTOM INTRUSION DETECTION RULES
------------------------------------------------

1. Create custom fail2ban filter for web attacks:
   # vim /etc/fail2ban/filter.d/custom-web-attacks.conf
   
   [Definition]
   failregex = ^<HOST> -.*"(GET|POST).*(/admin|/wp-admin|/phpmyadmin|\.php\?|union.*select|script>).*" (4|5)\d\d
               ^<HOST> -.*"(GET|POST).*(etc/passwd|proc/self|boot\.ini).*" (4|5)\d\d
               ^<HOST> -.*"(GET|POST).*(select.*from|union.*select|insert.*into|drop.*table).*" (4|5)\d\d
   
   ignoreregex =

2. Configure custom web attack jail:
   # vim /etc/fail2ban/jail.local
   
   [custom-web-attacks]
   enabled = true
   port = http,https
   filter = custom-web-attacks
   logpath = /var/log/httpd/access_log
   maxretry = 2
   bantime = 7200
   findtime = 300

3. Create network scan detection:
   # vim /usr/local/bin/detect-port-scan.sh
   
   #!/bin/bash
   # Port scan detection script
   
   LOG_FILE="/var/log/port-scan-detection.log"
   ALERT_EMAIL="security@example.com"
   THRESHOLD=20
   
   # Monitor netstat for connection attempts
   CONNECTIONS=$(netstat -an | grep SYN_RECV | wc -l)
   
   if [ $CONNECTIONS -gt $THRESHOLD ]; then
       {
           echo "$(date): Possible port scan detected"
           echo "SYN_RECV connections: $CONNECTIONS (threshold: $THRESHOLD)"
           echo
           echo "Top connecting IPs:"
           netstat -an | grep SYN_RECV | awk '{print $5}' | \
           cut -d':' -f1 | sort | uniq -c | sort -nr | head -10
       } | tee -a $LOG_FILE
       
       # Send alert
       tail -20 $LOG_FILE | mail -s "Port Scan Alert" $ALERT_EMAIL
   fi
   
   # chmod +x /usr/local/bin/detect-port-scan.sh

PART E: IMPLEMENT LOG-BASED INTRUSION DETECTION
------------------------------------------------

1. Create suspicious activity detector:
   # vim /usr/local/bin/detect-suspicious-activity.sh
   
   #!/bin/bash
   # Detect suspicious system activity
   
   SECURE_LOG="/var/log/secure"
   MESSAGES_LOG="/var/log/messages"
   ALERT_EMAIL="security@example.com"
   
   echo "=== Suspicious Activity Detection - $(date) ==="
   
   # Check for multiple failed logins
   FAILED_LOGINS=$(grep "$(date '+%b %d')" $SECURE_LOG | grep -c "authentication failure")
   if [ $FAILED_LOGINS -gt 50 ]; then
       echo "ALERT: High number of failed logins: $FAILED_LOGINS"
       {
           echo "High authentication failure rate detected"
           echo "Failed logins today: $FAILED_LOGINS"
           echo "Top attacking IPs:"
           grep "$(date '+%b %d')" $SECURE_LOG | grep "authentication failure" | \
           awk '{print $14}' | cut -d'=' -f2 | sort | uniq -c | sort -nr | head -10
       } | mail -s "Authentication Attack Alert" $ALERT_EMAIL
   fi
   
   # Check for privilege escalation attempts
   PRIV_ESC=$(grep "$(date '+%b %d')" $SECURE_LOG | grep -c "su.*root")
   if [ $PRIV_ESC -gt 10 ]; then
       echo "ALERT: Multiple privilege escalation attempts: $PRIV_ESC"
   fi
   
   # Check for unusual process activity
   UNUSUAL_PROCS=$(ps aux | grep -E "(nc|netcat|nmap|tcpdump)" | grep -v grep | wc -l)
   if [ $UNUSUAL_PROCS -gt 0 ]; then
       echo "ALERT: Unusual processes detected"
       ps aux | grep -E "(nc|netcat|nmap|tcpdump)" | grep -v grep
   fi
   
   # Check for new user accounts
   NEW_USERS=$(grep "$(date '+%b %d')" $SECURE_LOG | grep -c "new user")
   if [ $NEW_USERS -gt 0 ]; then
       echo "ALERT: New user accounts created: $NEW_USERS"
       grep "$(date '+%b %d')" $SECURE_LOG | grep "new user"
   fi
   
   # chmod +x /usr/local/bin/detect-suspicious-activity.sh

2. Create network intrusion detector:
   # vim /usr/local/bin/network-intrusion-detector.sh
   
   #!/bin/bash
   # Network-based intrusion detection
   
   INTERFACE="eth0"
   LOG_FILE="/var/log/network-intrusion.log"
   ALERT_EMAIL="security@example.com"
   
   # Monitor for suspicious network patterns
   {
       echo "$(date): Starting network monitoring on $INTERFACE"
       
       # Monitor for port scans (using netstat)
       SCAN_ATTEMPTS=$(netstat -an | grep SYN_RECV | wc -l)
       if [ $SCAN_ATTEMPTS -gt 10 ]; then
           echo "$(date): Port scan detected - $SCAN_ATTEMPTS SYN_RECV connections"
       fi
       
       # Monitor for unusual traffic patterns
       RX_BYTES=$(cat /sys/class/net/$INTERFACE/statistics/rx_bytes)
       TX_BYTES=$(cat /sys/class/net/$INTERFACE/statistics/tx_bytes)
       
       # Store previous values for comparison
       if [ -f /tmp/network_stats ]; then
           PREV_RX=$(awk '{print $1}' /tmp/network_stats)
           PREV_TX=$(awk '{print $2}' /tmp/network_stats)
           
           RX_DIFF=$((RX_BYTES - PREV_RX))
           TX_DIFF=$((TX_BYTES - PREV_TX))
           
           # Alert on unusual traffic (>100MB in 5 minutes)
           if [ $RX_DIFF -gt 104857600 ] || [ $TX_DIFF -gt 104857600 ]; then
               echo "$(date): Unusual traffic detected - RX: $RX_DIFF bytes, TX: $TX_DIFF bytes"
           fi
       fi
       
       echo "$RX_BYTES $TX_BYTES" > /tmp/network_stats
       
   } >> $LOG_FILE
   
   # chmod +x /usr/local/bin/network-intrusion-detector.sh

PART F: CONFIGURE AUTOMATED RESPONSE SYSTEM
--------------------------------------------

1. Create incident response script:
   # vim /usr/local/bin/incident-response.sh
   
   #!/bin/bash
   # Automated incident response
   
   INCIDENT_TYPE="$1"
   SOURCE_IP="$2"
   DETAILS="$3"
   
   LOG_FILE="/var/log/incident-response.log"
   ALERT_EMAIL="security@example.com"
   
   {
       echo "$(date): Incident Response Triggered"
       echo "Type: $INCIDENT_TYPE"
       echo "Source IP: $SOURCE_IP"
       echo "Details: $DETAILS"
       echo "---"
   } >> $LOG_FILE
   
   case "$INCIDENT_TYPE" in
       "brute_force")
           # Block IP with iptables
           iptables -I INPUT -s $SOURCE_IP -j DROP
           echo "$(date): Blocked IP $SOURCE_IP for brute force attack" >> $LOG_FILE
           ;;
       "port_scan")
           # Block IP and log
           iptables -I INPUT -s $SOURCE_IP -j DROP
           echo "$(date): Blocked IP $SOURCE_IP for port scanning" >> $LOG_FILE
           ;;
       "file_integrity")
           # Lock down system
           echo "$(date): File integrity violation - system locked down" >> $LOG_FILE
           # Could implement additional lockdown measures here
           ;;
   esac
   
   # Send alert email
   {
       echo "Security incident detected on $(hostname)"
       echo "Type: $INCIDENT_TYPE"
       echo "Source: $SOURCE_IP"
       echo "Time: $(date)"
       echo "Details: $DETAILS"
       echo
       echo "Automated response taken - check $LOG_FILE for details"
   } | mail -s "Security Incident: $INCIDENT_TYPE" $ALERT_EMAIL
   
   # chmod +x /usr/local/bin/incident-response.sh

2. Create threat intelligence integration:
   # vim /usr/local/bin/threat-intel-check.sh
   
   #!/bin/bash
   # Check IPs against threat intelligence feeds
   
   IP_ADDRESS="$1"
   
   if [ -z "$IP_ADDRESS" ]; then
       echo "Usage: $0 <ip_address>"
       exit 1
   fi
   
   echo "Checking $IP_ADDRESS against threat intelligence..."
   
   # Check against known bad IP lists (example using public feeds)
   # Note: In production, use proper threat intelligence APIs
   
   # Check if IP is in private ranges (not malicious)
   if echo "$IP_ADDRESS" | grep -qE "^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)" ; then
       echo "IP is in private range - likely not malicious"
       exit 0
   fi
   
   # Simple reputation check (placeholder)
   # In real implementation, integrate with threat intel APIs
   echo "Threat intelligence check for $IP_ADDRESS completed"
   
   # Log the check
   echo "$(date): Threat intel check for $IP_ADDRESS" >> /var/log/threat-intel.log
   
   # chmod +x /usr/local/bin/threat-intel-check.sh

PART G: CONFIGURE SYSTEM INTEGRITY MONITORING
----------------------------------------------

1. Create system integrity checker:
   # vim /usr/local/bin/system-integrity-check.sh
   
   #!/bin/bash
   # Comprehensive system integrity check
   
   LOG_FILE="/var/log/system-integrity.log"
   ALERT_EMAIL="security@example.com"
   
   {
       echo "=== System Integrity Check - $(date) ==="
       
       # Check for unauthorized SUID files
       echo "Checking for unauthorized SUID files..."
       find / -type f -perm -4000 2>/dev/null | \
       while read file; do
           if ! rpm -qf "$file" >/dev/null 2>&1; then
               echo "WARNING: Unauthorized SUID file: $file"
           fi
       done
       
       # Check for world-writable files
       echo "Checking for world-writable files..."
       find / -type f -perm -002 2>/dev/null | head -20
       
       # Check for files without owner
       echo "Checking for files without owner..."
       find / -nouser -o -nogroup 2>/dev/null | head -10
       
       # Check system accounts
       echo "Checking system accounts..."
       awk -F: '$3 == 0 {print "UID 0 account: " $1}' /etc/passwd
       
       # Check for empty password accounts
       echo "Checking for empty password accounts..."
       awk -F: '$2 == "" {print "Empty password: " $1}' /etc/shadow
       
       # Check listening services
       echo "Checking listening services..."
       netstat -tulpn | grep LISTEN
       
       echo "=== System Integrity Check Complete ==="
       
   } | tee -a $LOG_FILE
   
   # Check if any issues were found and alert
   if grep -q "WARNING\|Empty password" $LOG_FILE; then
       tail -50 $LOG_FILE | mail -s "System Integrity Issues Found" $ALERT_EMAIL
   fi
   
   # chmod +x /usr/local/bin/system-integrity-check.sh

PART H: START SERVICES AND SCHEDULE MONITORING
-----------------------------------------------

1. Start and configure services:
   # systemctl start fail2ban
   # systemctl status fail2ban

2. Schedule intrusion detection tasks:
   # crontab -e
   # Add the following entries:
   
   # AIDE integrity checks (daily)
   0 2 * * * /usr/local/bin/aide-check.sh
   
   # Suspicious activity detection (every 15 minutes)
   */15 * * * * /usr/local/bin/detect-suspicious-activity.sh
   
   # Port scan detection (every 5 minutes)
   */5 * * * * /usr/local/bin/detect-port-scan.sh
   
   # Network intrusion detection (every 5 minutes)
   */5 * * * * /usr/local/bin/network-intrusion-detector.sh
   
   # System integrity check (weekly)
   0 3 * * 0 /usr/local/bin/system-integrity-check.sh

3. Configure log rotation for intrusion detection logs:
   # vim /etc/logrotate.d/intrusion-detection
   
   /var/log/aide/*.log
   /var/log/port-scan-detection.log
   /var/log/network-intrusion.log
   /var/log/incident-response.log
   /var/log/threat-intel.log
   /var/log/system-integrity.log
   {
       daily
       missingok
       rotate 30
       compress
       delaycompress
       notifempty
       create 644 root root
   }

PART I: TESTING INTRUSION DETECTION SYSTEMS
--------------------------------------------

1. Test AIDE file integrity monitoring:
   # echo "test" > /etc/test-file
   # /usr/local/bin/aide-check.sh
   # rm /etc/test-file

2. Test fail2ban SSH protection:
   # From another system, attempt multiple failed SSH logins
   # ssh wronguser@192.168.1.10  # Repeat several times with wrong password
   # fail2ban-client status sshd

3. Test suspicious activity detection:
   # /usr/local/bin/detect-suspicious-activity.sh

4. Test port scan detection:
   # From another system: nmap -sS 192.168.1.10
   # /usr/local/bin/detect-port-scan.sh

5. Test system integrity check:
   # /usr/local/bin/system-integrity-check.sh

6. Check fail2ban status:
   # fail2ban-client status
   # fail2ban-client status sshd

PART J: CREATE INTRUSION DETECTION DASHBOARD
---------------------------------------------

1. Create IDS status dashboard:
   # vim /usr/local/bin/ids-dashboard.sh
   
   #!/bin/bash
   # Intrusion Detection System Dashboard
   
   echo "=== Intrusion Detection System Dashboard ==="
   echo "Generated: $(date)"
   echo "Host: $(hostname)"
   echo "============================================="
   echo
   
   # AIDE Status
   echo "=== AIDE File Integrity Monitoring ==="
   if [ -f /var/lib/aide/aide.db.gz ]; then
       echo "AIDE Database: Present"
       echo "Last check: $(ls -l /var/log/aide/ | tail -1 | awk '{print $6, $7, $8}')"
   else
       echo "AIDE Database: Missing - run aide --init"
   fi
   echo
   
   # Fail2ban Status
   echo "=== Fail2ban Status ==="
   if systemctl is-active fail2ban >/dev/null 2>&1; then
       echo "Fail2ban: Active"
       fail2ban-client status | grep "Jail list"
       echo "Currently banned IPs:"
       fail2ban-client status sshd | grep "Banned IP list"
   else
       echo "Fail2ban: Inactive"
   fi
   echo
   
   # Recent Security Events
   echo "=== Recent Security Events ==="
   echo "Failed SSH attempts (last 24h):"
   grep "$(date '+%b %d')" /var/log/secure | grep -c "authentication failure"
   
   echo "Blocked IPs (last 24h):"
   if [ -f /var/log/incident-response.log ]; then
       grep "$(date '+%Y-%m-%d')" /var/log/incident-response.log | grep -c "Blocked IP"
   else
       echo "0"
   fi
   echo
   
   # System Status
   echo "=== System Security Status ==="
   echo "Load average: $(uptime | awk -F'load average:' '{print $2}')"
   echo "Active connections: $(netstat -an | grep ESTABLISHED | wc -l)"
   echo "Listening services: $(netstat -tulpn | grep LISTEN | wc -l)"
   
   # chmod +x /usr/local/bin/ids-dashboard.sh

2. Create security report generator:
   # vim /usr/local/bin/generate-security-report.sh
   
   #!/bin/bash
   # Generate comprehensive security report
   
   REPORT_FILE="/var/log/security-report-$(date +%Y%m%d).txt"
   
   {
       /usr/local/bin/ids-dashboard.sh
       echo
       echo "=== Detailed Analysis ==="
       /usr/local/bin/detect-suspicious-activity.sh
       echo
       /usr/local/bin/system-integrity-check.sh
       
   } > $REPORT_FILE
   
   echo "Security report generated: $REPORT_FILE"
   
   # Email the report
   mail -s "Daily Security Report - $(hostname)" security@example.com < $REPORT_FILE
   
   # chmod +x /usr/local/bin/generate-security-report.sh

TROUBLESHOOTING COMMANDS:
-------------------------
# aide --check
# fail2ban-client status
# fail2ban-client status sshd
# systemctl status fail2ban
# tail -f /var/log/fail2ban.log
# iptables -L -n | grep fail2ban

EXPECTED RESULTS:
-----------------
- AIDE monitoring file system integrity
- Fail2ban blocking brute force attacks
- Custom detection scripts identifying threats
- Automated incident response working
- Comprehensive logging and alerting
- Regular security reports generated

VALIDATION CHECKLIST:
---------------------
□ AIDE database initialized and checking
□ Fail2ban service active and protecting SSH
□ Custom intrusion detection scripts working
□ Automated response system functional
□ Log monitoring detecting suspicious activity
□ Security reports being generated
□ Alert emails being sent

CLEANUP:
--------
# systemctl stop fail2ban
# systemctl disable fail2ban
# rm /usr/local/bin/aide-*.sh
# rm /usr/local/bin/detect-*.sh
# rm /usr/local/bin/network-*.sh
# rm /usr/local/bin/incident-*.sh
# rm /usr/local/bin/threat-*.sh
# rm /usr/local/bin/system-*.sh
# rm /usr/local/bin/ids-*.sh
# rm /usr/local/bin/generate-*.sh
# crontab -e  # Remove monitoring entries
# rm -rf /var/lib/aide/
